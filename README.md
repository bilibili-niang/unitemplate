# uni-ts-template

## å‘½ä»¤è¡Œåˆ›å»º uni-app é¡¹ç›®

**ä¼˜åŠ¿**

é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º uni-app é¡¹ç›®ï¼Œ**ä¸å¿…ä¾èµ– HBuilderX**ï¼ŒTypeScript ç±»å‹æ”¯æŒå‹å¥½ã€‚

**å‘½ä»¤è¡Œåˆ›å»º uni-app é¡¹ç›®ï¼š**	

- vue3 + ts ç‰ˆ

```bash
# é€šè¿‡ git ä» gitee å…‹éš†ä¸‹è½½
git clone -b vite-ts https://gitee.com/dcloud/uni-preset-vue.git

# é€šè¿‡ git ä» gitee æ‰‹åŠ¨ä¸‹è½½
https://gitee.com/dcloud/uni-preset-vue/repository/archive/vite-ts.zip

# é€šè¿‡ npx ä» github ä¸‹è½½
npx degit dcloudio/uni-preset-vue#vite-ts é¡¹ç›®åç§°
```

åˆ›å»ºå…¶ä»–ç‰ˆæœ¬å¯æŸ¥çœ‹ï¼š[uni-app å®˜ç½‘](https://uniapp.dcloud.net.cn/quickstart-cli.html)

**å¸¸è§é—®é¢˜**

- è¿è¡Œ `npx` å‘½ä»¤ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•æ¢æˆ**æ‰‹æœºçƒ­ç‚¹é‡è¯•**
- æ¢æ‰‹æœºçƒ­ç‚¹ä¾æ—§å¤±è´¥ï¼Œè¯·å°è¯•ä»[å›½å†…å¤‡ç”¨åœ°å€ä¸‹è½½](https://gitee.com/dcloud/uni-preset-vue/tree/vite-ts/)
- åœ¨ `manifest.json` æ–‡ä»¶æ·»åŠ  [å°ç¨‹åº AppID](https://mp.weixin.qq.com/) ç”¨äºçœŸæœºé¢„è§ˆ
- è¿è¡Œ `npx` å‘½ä»¤éœ€ä¾èµ– NodeJS ç¯å¢ƒï¼Œ[NodeJS ä¸‹è½½åœ°å€](https://nodejs.org/zh-cn)
- è¿è¡Œ `git` å‘½ä»¤éœ€ä¾èµ– Git ç¯å¢ƒï¼Œ[Git ä¸‹è½½åœ°å€](https://git-scm.com/download/)



### ç¼–è¯‘å’Œè¿è¡Œ uni-app é¡¹ç›®

1. å®‰è£…ä¾èµ– `pnpm install`
2. ç¼–è¯‘æˆå¾®ä¿¡å°ç¨‹åº `pnpm dev:mp-weixin`
3. å¯¼å…¥å¾®ä¿¡å¼€å‘è€…å·¥å…·

**æ¸©é¦¨æç¤º**

- ç¼–è¯‘æˆ H5 ç«¯å¯è¿è¡Œ `pnpm dev:h5` é€šè¿‡æµè§ˆå™¨é¢„è§ˆé¡¹ç›®ã€‚



## ç”¨ VS Code å¼€å‘ uni-app é¡¹ç›®

### ä¸ºä»€ä¹ˆé€‰æ‹© VS Codeï¼Ÿ

- VS Code å¯¹ **TS ç±»å‹æ”¯æŒå‹å¥½**ï¼Œå‰ç«¯å¼€å‘è€…**ä¸»æµçš„ç¼–è¾‘å™¨**
- HbuilderX å¯¹ TS ç±»å‹æ”¯æŒæš‚ä¸å®Œå–„ï¼ŒæœŸå¾…å®˜æ–¹å®Œå–„ ğŸ‘€

### ç”¨ VS Code å¼€å‘é…ç½®

é¡¹ç›®é‡‡ç”¨ Vue3 + TS å¼€å‘ uni-app é¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦åˆ†åˆ«å®‰è£… Vue3 + TS æ’ä»¶ å’Œ uni-app æ’ä»¶ã€‚

**æ¸©é¦¨æç¤º**

> `VS Code` å¯é€šè¿‡å¿«æ·é”® `Ctrl + i` å”¤èµ·ä»£ç æç¤ºã€‚

#### å®‰è£… Vue3 + TS æ’ä»¶

**æ³¨æ„äº‹é¡¹**

æ²¡å¼€å‘è¿‡ Vue3 + TS é¡¹ç›®çš„å°ä¼™ä¼´æ³¨æ„ï¼Œéœ€è¦å…ˆå®‰è£… Vue3 å’Œ TS çš„æ’ä»¶ï¼Œå¹¶å®Œæˆä»¥ä¸‹é…ç½® ğŸ‘‡

- å®‰è£… [Vue Language Features (Volar)](https://marketplace.visualstudio.com/items?itemName=Vue.volar) ï¼šVue3 è¯­æ³•æç¤ºæ’ä»¶
- å®‰è£… [TypeScript Vue Plugin (Volar)](https://marketplace.visualstudio.com/items?itemName=Vue.vscode-typescript-vue-plugin) ï¼šVue3 çš„ TS æ’ä»¶
- **å·¥ä½œåŒºç¦ç”¨** Vetur æ’ä»¶(Vue2 æ’ä»¶å’Œ Vue3 æ’ä»¶å†²çª)
- **å·¥ä½œåŒºç¦ç”¨** @builtin typescript æ’ä»¶ï¼ˆç¦ç”¨åè‡ªåŠ¨å¼€å¯ Vue3 çš„ TS æ‰˜ç®¡æ¨¡å¼ï¼‰

[æŸ¥çœ‹ Vue3 å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/guide/typescript/overview.html#ide-support)

![image1](https://megasu.gitee.io/uni-app-shop-note/assets/uniapp_vscode_setting.75574ba6.png)

#### å®‰è£… uni-app æ’ä»¶

- ğŸ‘‰ å®‰è£… uni-app å¼€å‘æ’ä»¶
  - [uni-create-view](https://marketplace.visualstudio.com/items?itemName=mrmaoddxxaa.create-uniapp-view) ï¼šå¿«é€Ÿåˆ›å»º uni-app é¡µé¢
  - [uni-helper](https://marketplace.visualstudio.com/items?itemName=uni-helper.uni-helper-vscode) ï¼šuni-app ä»£ç æç¤º
  - [uniapp å°ç¨‹åºæ‰©å±•](https://marketplace.visualstudio.com/items?itemName=evils.uniapp-vscode) ï¼šé¼ æ ‡æ‚¬åœæŸ¥æ–‡æ¡£
- ğŸ‘‰ TS ç±»å‹æ ¡éªŒ
  - å®‰è£… **ç±»å‹å£°æ˜æ–‡ä»¶** `pnpm i -D miniprogram-api-typings @uni-helper/uni-app-types`
  - é…ç½® `tsconfig.json`
- ğŸ‘‰ JSON æ³¨é‡Šé—®é¢˜
  - è®¾ç½®æ–‡ä»¶å…³è”ï¼ŒæŠŠ `manifest.json` å’Œ `pages.json` è®¾ç½®ä¸º `jsonc`

`tsconfig.json` å‚è€ƒ

```json
{
  "extends": "@vue/tsconfig/tsconfig.json",
  "compilerOptions": {
    "allowJs": true,
    "sourceMap": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "lib": ["esnext", "dom"],
    // ç±»å‹å£°æ˜æ–‡ä»¶
    "types": [
      "@dcloudio/types", // uni-app API ç±»å‹
      "miniprogram-api-typings", // åŸç”Ÿå¾®ä¿¡å°ç¨‹åºç±»å‹
      "@uni-helper/uni-app-types", // uni-app ç»„ä»¶ç±»å‹
      "@uni-helper/uni-ui-types" // uni-ui ç»„ä»¶ç±»å‹
    ]
  },
  // æ ¡éªŒ uni-app ç»„ä»¶ç±»å‹
  "vueCompilerOptions": {
    // experimentalRuntimeMode å·²åºŸå¼ƒï¼Œç°è°ƒæ•´ä¸º nativeTagsï¼Œè¯·å‡çº§ Volar æ’ä»¶è‡³æœ€æ–°ç‰ˆæœ¬
    "nativeTags": ["block", "component", "template", "slot"]
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"]
}
```

**å·¥ä½œåŒºè®¾ç½®å‚è€ƒ**

```json
// .vscode/settings.json
{
  // åœ¨ä¿å­˜æ—¶æ ¼å¼åŒ–æ–‡ä»¶
  "editor.formatOnSave": true,
  // æ–‡ä»¶æ ¼å¼åŒ–é…ç½®
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  // é…ç½®è¯­è¨€çš„æ–‡ä»¶å…³è”
  "files.associations": {
    "pages.json": "jsonc", // pages.json å¯ä»¥å†™æ³¨é‡Š
    "manifest.json": "jsonc" // manifest.json å¯ä»¥å†™æ³¨é‡Š
  }
}
```

**ç‰ˆæœ¬å‡çº§**

> - åŸä¾èµ– `@types/wechat-miniprogram` ç°è°ƒæ•´ä¸º [miniprogram-api-typings](https://github.com/wechat-miniprogram/api-typings)ã€‚
> - åŸé…ç½® `experimentalRuntimeMode` ç°è°ƒæ•´ä¸º `nativeTags`ã€‚

è¿™ä¸€æ­¥å¤„ç†å¾ˆå…³é”®ï¼Œå¦åˆ™ TS é¡¹ç›®ï¼Œæ— æ³•æ ¡éªŒç»„ä»¶å±æ€§ç±»å‹ã€‚

## å¼€å‘å·¥å…·å›é¡¾

é€‰æ‹©è‡ªå·±ä¹ æƒ¯çš„ç¼–è¾‘å™¨å¼€å‘ uni-app é¡¹ç›®å³å¯ã€‚

**HbuilderX å’Œ å¾®ä¿¡å¼€å‘è€…å·¥å…· å…³ç³»**![HbuilderX å’Œ å¾®ä¿¡å¼€å‘è€…å·¥å…· å…³ç³»](https://megasu.gitee.io/uni-app-shop-note/assets/uniapp_picture_7.f5fc8df3.png)

**VS Code å’Œ å¾®ä¿¡å¼€å‘è€…å·¥å…· å…³ç³»**![VS Code å’Œ å¾®ä¿¡å¼€å‘è€…å·¥å…· å…³ç³»](https://megasu.gitee.io/uni-app-shop-note/assets/uniapp_picture_8.a65fa881.png)



## å¼•å…¥ uni-ui ç»„ä»¶åº“

### æ“ä½œæ­¥éª¤

å®‰è£… [uni-ui ç»„ä»¶åº“](https://uniapp.dcloud.net.cn/component/uniui/quickstart.html#npmå®‰è£…)

```bash
pnpm i @dcloudio/uni-ui
```

**é…ç½®è‡ªåŠ¨å¯¼å…¥ç»„ä»¶**

```json
// pages.json
{
  // ç»„ä»¶è‡ªåŠ¨å¯¼å…¥
  "easycom": {
    "autoscan": true,
    "custom": {
      // uni-ui è§„åˆ™å¦‚ä¸‹é…ç½®  
      "^uni-(.*)": "@dcloudio/uni-ui/lib/uni-$1/uni-$1.vue" 
    }
  },
  "pages": [
    // â€¦çœç•¥
  ]
}
```

**å®‰è£…ç±»å‹å£°æ˜æ–‡ä»¶**

```sh
pnpm i -D @uni-helper/uni-ui-types
```

**é…ç½®ç±»å‹å£°æ˜æ–‡ä»¶**

```json
// tsconfig.json
{
  "compilerOptions": {
    // ...
    "types": [
      "@dcloudio/types", // uni-app API ç±»å‹
      "miniprogram-api-typings", // åŸç”Ÿå¾®ä¿¡å°ç¨‹åºç±»å‹
      "@uni-helper/uni-app-types", // uni-app ç»„ä»¶ç±»å‹
      "@uni-helper/uni-ui-types" // uni-ui ç»„ä»¶ç±»å‹  
    ]
  },
  // vue ç¼–è¯‘å™¨ç±»å‹ï¼Œæ ¡éªŒæ ‡ç­¾ç±»å‹
  "vueCompilerOptions": {
    "nativeTags": ["block", "component", "template", "slot"]
  }
}
```

## å°ç¨‹åºç«¯ Pinia æŒä¹…åŒ–

è¯´æ˜ï¼š`Pinia` ç”¨æ³•ä¸ `Vue3` é¡¹ç›®å®Œå…¨ä¸€è‡´ï¼Œ`uni-app` é¡¹ç›®ä»…éœ€è§£å†³**æŒä¹…åŒ–æ’ä»¶å…¼å®¹æ€§**é—®é¢˜ã€‚

### æŒä¹…åŒ–å­˜å‚¨æ’ä»¶

å®‰è£…æŒä¹…åŒ–å­˜å‚¨æ’ä»¶ï¼š [pinia-plugin-persistedstate](https://prazdevs.github.io/pinia-plugin-persistedstate/zh/guide/config.html#storage)

```sh
pnpm i pinia-plugin-persistedstate
```

æ’ä»¶é»˜è®¤ä½¿ç”¨ `localStorage` å®ç°æŒä¹…åŒ–ï¼Œå°ç¨‹åºç«¯ä¸å…¼å®¹ï¼Œéœ€è¦æ›¿æ¢æŒä¹…åŒ– APIã€‚

### åŸºæœ¬ç”¨æ³•

**stores/modules/member.ts**

```ts
import { defineStore } from 'pinia'
import { ref } from 'vue'

// å®šä¹‰ Store
export const useMemberStore = defineStore(
  'member',
  () => {
    // ä¼šå‘˜ä¿¡æ¯
    const profile = ref<any>()

    // ä¿å­˜ä¼šå‘˜ä¿¡æ¯ï¼Œç™»å½•æ—¶ä½¿ç”¨
    const setProfile = (val: any) => {
      profile.value = val
    }

    // æ¸…ç†ä¼šå‘˜ä¿¡æ¯ï¼Œé€€å‡ºæ—¶ä½¿ç”¨
    const clearProfile = () => {
      profile.value = undefined
    }

    // è®°å¾— return
    return {
      profile,
      setProfile,
      clearProfile,
    }
  },
  // TODO: æŒä¹…åŒ–
  {
    persist: true,
  },
)
```

**stores/index.ts**

```tsx
import { createPinia } from 'pinia'
import persist from 'pinia-plugin-persistedstate'

// åˆ›å»º pinia å®ä¾‹
const pinia = createPinia()
// ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨æ’ä»¶
pinia.use(persist)

// é»˜è®¤å¯¼å‡ºï¼Œç»™ main.ts ä½¿ç”¨
export default pinia

// æ¨¡å—ç»Ÿä¸€å¯¼å‡º
export * from './modules/member'
```

**main.ts**

```tsx
import { createSSRApp } from 'vue'
import pinia from './stores'

import App from './App.vue'
export function createApp() {
  const app = createSSRApp(App)

  app.use(pinia)
  return {
    app,
  }
}
```

### å¤šç«¯å…¼å®¹

**ç½‘é¡µç«¯æŒä¹…åŒ– API**

```js
// ç½‘é¡µç«¯API
localStorage.setItem()
localStorage.getItem()
```

**å¤šç«¯æŒä¹…åŒ– API**

```js
// å…¼å®¹å¤šç«¯API
uni.setStorageSync()
uni.getStorageSync()
```

**å‚è€ƒä»£ç **

```tsx
// stores/modules/member.ts
export const useMemberStore = defineStore(
  'member',
  () => {
    //â€¦çœç•¥
  },
  {
    // é…ç½®æŒä¹…åŒ–
    persist: {
      // è°ƒæ•´ä¸ºå…¼å®¹å¤šç«¯çš„API
      storage: {
        setItem(key, value) {
          uni.setStorageSync(key, value) 
        },
        getItem(key) {
          return uni.getStorageSync(key) 
        },
      },
    },
  },
)
```

## uni.request è¯·æ±‚å°è£…

### ç¬¬ä¸€ç§ï¼šè¯·æ±‚å’Œä¸Šä¼ æ–‡ä»¶æ‹¦æˆªå™¨

**uniapp æ‹¦æˆªå™¨**ï¼š [uni.addInterceptor](https://uniapp.dcloud.net.cn/api/interceptor.html)

**æ¥å£è¯´æ˜**ï¼š[æ¥å£æ–‡æ¡£](https://www.apifox.cn/apidoc/shared-0e6ee326-d646-41bd-9214-29dbf47648fa/doc-1521513)

> **å®ç°éœ€æ±‚**
>
> 1. æ‹¼æ¥åŸºç¡€åœ°å€
> 2. è®¾ç½®è¶…æ—¶æ—¶é—´
> 3. æ·»åŠ è¯·æ±‚å¤´æ ‡è¯†
> 4. æ·»åŠ  token

**å‚è€ƒä»£ç **

```tsx
// src/utils/http.ts

// è¯·æ±‚åŸºåœ°å€
const baseURL = 'https://pcapi-xiaotuxian-front-devtest.itheima.net'

// æ‹¦æˆªå™¨é…ç½®
const httpInterceptor = {
  // æ‹¦æˆªå‰è§¦å‘
  invoke(options: UniApp.RequestOptions) {
    // 1. é http å¼€å¤´éœ€æ‹¼æ¥åœ°å€
    if (!options.url.startsWith('http')) {
      options.url = baseURL + options.url
    }
    // 2. è¯·æ±‚è¶…æ—¶
    options.timeout = 10000
    // 3. æ·»åŠ å°ç¨‹åºç«¯è¯·æ±‚å¤´æ ‡è¯†
    options.header = {
      'source-client': 'miniapp',
      ...options.header,
    }
    // 4. æ·»åŠ  token è¯·æ±‚å¤´æ ‡è¯†
    const memberStore = useMemberStore()
    const token = memberStore.profile?.token
    if (token) {
      options.header.Authorization = token
    }
  },
}

// æ‹¦æˆª request è¯·æ±‚
uni.addInterceptor('request', httpInterceptor)
// æ‹¦æˆª uploadFile æ–‡ä»¶ä¸Šä¼ 
uni.addInterceptor('uploadFile', httpInterceptor)
```

#### å°è£… Promise è¯·æ±‚å‡½æ•°

> å®ç°éœ€æ±‚
>
> 1. è¿”å› Promise å¯¹è±¡ï¼Œç”¨äºå¤„ç†è¿”å›å€¼ç±»å‹
> 2. æˆåŠŸ resolve
>    1. æå–æ•°æ®
>    2. æ·»åŠ æ³›å‹
> 3. å¤±è´¥ reject
>    1. 401 é”™è¯¯
>    2. å…¶ä»–é”™è¯¯
>    3. ç½‘ç»œé”™è¯¯

**å‚è€ƒä»£ç **

```tsx
/**
 * è¯·æ±‚å‡½æ•°
 * @param  UniApp.RequestOptions
 * @returns Promise
 *  1. è¿”å› Promise å¯¹è±¡ï¼Œç”¨äºå¤„ç†è¿”å›å€¼ç±»å‹
 *  2. è·å–æ•°æ®æˆåŠŸ
 *    2.1 æå–æ ¸å¿ƒæ•°æ® res.data
 *    2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
 *  3. è·å–æ•°æ®å¤±è´¥
 *    3.1 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
 *    3.2 å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
 *    3.3 ç½‘ç»œé”™è¯¯ -> æç¤ºç”¨æˆ·æ¢ç½‘ç»œ
 */
type Data<T> = {
  code: string
  msg: string
  result: T
}
// 2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
export const http = <T>(options: UniApp.RequestOptions) => {
  // 1. è¿”å› Promise å¯¹è±¡
  return new Promise<Data<T>>((resolve, reject) => {
    uni.request({
      ...options,
      // å“åº”æˆåŠŸ
      success(res) {
        // çŠ¶æ€ç  2xxï¼Œå‚è€ƒ axios çš„è®¾è®¡
        if (res.statusCode >= 200 && res.statusCode < 300) {
          // 2.1 æå–æ ¸å¿ƒæ•°æ® res.data
          resolve(res.data as Data<T>)
        } else if (res.statusCode === 401) {
          // 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          const memberStore = useMemberStore()
          memberStore.clearProfile()
          uni.navigateTo({ url: '/pages/login/login' })
          reject(res)
        } else {
          // å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
          uni.showToast({
            icon: 'none',
            title: (res.data as Data<T>).msg || 'è¯·æ±‚é”™è¯¯',
          })
          reject(res)
        }
      },
      // å“åº”å¤±è´¥
      fail(err) {
        uni.showToast({
          icon: 'none',
          title: 'ç½‘ç»œé”™è¯¯ï¼Œæ¢ä¸ªç½‘ç»œè¯•è¯•',
        })
        reject(err)
      },
    })
  })
}
```

#### **æ•´ä½“ä»£ç **

```tsx
/**
 * æ·»åŠ æ‹¦æˆªå™¨:
 *   æ‹¦æˆª request è¯·æ±‚
 *   æ‹¦æˆª uploadFile æ–‡ä»¶ä¸Šä¼ 
 *
 * TODO:
 *   1. é http å¼€å¤´éœ€æ‹¼æ¥åœ°å€
 *   2. è¯·æ±‚è¶…æ—¶
 *   3. æ·»åŠ å°ç¨‹åºç«¯è¯·æ±‚å¤´æ ‡è¯†
 *   4. æ·»åŠ  token è¯·æ±‚å¤´æ ‡è¯†
 */

import { useMemberStore } from '@/stores'

const baseURL = 'https://pcapi-xiaotuxian-front-devtest.itheima.net'

// æ·»åŠ æ‹¦æˆªå™¨
const httpInterceptor = {
  // æ‹¦æˆªå‰è§¦å‘
  invoke(options: UniApp.RequestOptions) {
    // 1. é http å¼€å¤´éœ€æ‹¼æ¥åœ°å€
    if (!options.url.startsWith('http')) {
      options.url = baseURL + options.url
    }
    // 2. è¯·æ±‚è¶…æ—¶, é»˜è®¤ 60s
    options.timeout = 10000
    // 3. æ·»åŠ å°ç¨‹åºç«¯è¯·æ±‚å¤´æ ‡è¯†
    options.header = {
      ...options.header,
      'source-client': 'miniapp',
    }
    // 4. æ·»åŠ  token è¯·æ±‚å¤´æ ‡è¯†
    const memberStore = useMemberStore()
    const token = memberStore.profile?.token
    if (token) {
      options.header.Authorization = token
    }
  },
}
uni.addInterceptor('request', httpInterceptor)
uni.addInterceptor('uploadFile', httpInterceptor)

/**
 * è¯·æ±‚å‡½æ•°
 * @param  UniApp.RequestOptions
 * @returns Promise
 *  1. è¿”å› Promise å¯¹è±¡
 *  2. è·å–æ•°æ®æˆåŠŸ
 *    2.1 æå–æ ¸å¿ƒæ•°æ® res.data
 *    2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
 *  3. è·å–æ•°æ®å¤±è´¥
 *    3.1 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
 *    3.2 å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
 *    3.3 ç½‘ç»œé”™è¯¯ -> æç¤ºç”¨æˆ·æ¢ç½‘ç»œ
 */
type Data<T> = {
  code: string
  msg: string
  result: T
}
// 2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
export const http = <T>(options: UniApp.RequestOptions) => {
  // 1. è¿”å› Promise å¯¹è±¡
  return new Promise<Data<T>>((resolve, reject) => {
    uni.request({
      ...options,
      // å“åº”æˆåŠŸ
      success(res) {
        // çŠ¶æ€ç  2xxï¼Œ axios å°±æ˜¯è¿™æ ·è®¾è®¡çš„
        if (res.statusCode >= 200 && res.statusCode < 300) {
          // 2.1 æå–æ ¸å¿ƒæ•°æ® res.data
          resolve(res.data as Data<T>)
        } else if (res.statusCode === 401) {
          // 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          const memberStore = useMemberStore()
          memberStore.clearProfile()
          uni.navigateTo({ url: '/pages/login/login' })
          reject(res)
        } else {
          // å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
          uni.showToast({
            icon: 'none',
            title: (res.data as Data<T>).msg || 'è¯·æ±‚é”™è¯¯',
          })
          reject(res)
        }
      },
      // å“åº”å¤±è´¥
      fail(err) {
        uni.showToast({
          icon: 'none',
          title: 'ç½‘ç»œé”™è¯¯ï¼Œæ¢ä¸ªç½‘ç»œè¯•è¯•',
        })
        reject(err)
      },
    })
  })
}

```

### ç¬¬äºŒç§ï¼šæ¨èå°è£…ï¼ˆå…¼å®¹PCã€APPï¼Œå°ç¨‹åºï¼‰

**å‚è€ƒä»£ç **

```json
import { nanoid } from 'nanoid'
import { checkLogin, getNowDate, isTokenLose, removeStorage } from '@/utils/global.js'
import { AUTHORIZATION, JWTVALIDATE, CLIENTID, JWTVALIDATETIME} from '@/utils/constant.js'

export let base_url = ''
export let context = ''
export let h5_url = ''
// H5
// let url ='/api/system/login' //éœ€è¦æ‹¼æ¥ä¸Š/api
// #ifdef H5
	// base_url = 'http://10.1.28.121:9001'
	h5_url = 'https://uniapp.t.yindangu.com' // ç”¨æ¥æ‰“å¼€PCç«¯é¡µé¢
	context = '/api'
// #endif

// MP
// let url = base_url + '/system/login'
// #ifdef MP-WEIXIN
	const accountInfo = wx.getAccountInfoSync();
	// envç±»å‹
	export const env = accountInfo.miniProgram.envVersion || 'develop';
	// ç³»ç»Ÿåˆ¤æ–­åŒºåˆ†url
	const baseApi = {
		// å¼€å‘ç‰ˆ
		develop: {
			apiUrl: "https://uniapp.t.yindangu.com", //å¼€å‘ç‰ˆ
		},
		// ä½“éªŒç‰ˆ
		trial: {
			apiUrl: "https://uniapp.t.yindangu.com", //ä½“éªŒç¯å¢ƒ
		},
		// æ­£å¼ç‰ˆ
		release: {
			apiUrl: "https://uniapp.t.yindangu.com", //æ­£å¼ç¯å¢ƒ
		}
	}
	base_url = baseApi[env].apiUrl
	context = ''
	
// #endif

// #ifdef APP-PLUS
	base_url = "https://uniapp.t.yindangu.com"
	context = ''
// #endif

export const request = async (params) => {
	
	// å‚æ•°
	const {
		url = '', data = {}, type = '', method = 'POST'
	} = params
	
	
	// é…ç½®è¯·æ±‚å¤´
	let authorization = uni.getStorageSync(AUTHORIZATION) || ''
	let LoginClientId = uni.getStorageSync(CLIENTID) || ''
	// const res = await JWTValidateJson({ LoginClientId, jwt: authorization, timeStamp: Date.now(), nonce: LoginClientId })
	// console.log(res, 'JWTValidateJson');
	await JWTValidateJson({ LoginClientId, jwt: authorization, timeStamp: Date.now(), nonce: LoginClientId })
	// console.log(11111);
	let jwtValidate = uni.getStorageSync(JWTVALIDATE) || ''
	let header = {
		"content-type": "application/json; charset=utf-8",
		"Authorization": authorization,
		'V-Jwt-Login-State': 'login',
		'V-Jwt-Validate': jwtValidate
	}

	// è¯·æ±‚
	return new Promise(async (resolve, reject) => {
		await uni.request({
			url: base_url + context + url,
			data,
			header,
			method,
			// withCredentials: true
		}).then((res) => {
			if(res.statusCode == 200) {
				resolve(res.data.data)
			} else {
				reject(res)
			}
		}).catch((err) => {
			return uni.showToast({
				icon: "none",
				title: "è¯·æ±‚æ¥å£å¤±è´¥"
			})
			reject(err)
		})
	})
}


/**
 * JWTæ ¡éªŒåŠ å¯†å€¼
 */
export const JWTValidateJson =(params) => {
	if(!isTokenLose()) return
	return new Promise((resolve, reject) => {
		uni.request({
			url: base_url + context +'/webapi/vbase_prd_united_login_api/API_JWTValidateJson',
			data: params,
			method: 'POST'
		}).then(res => {
			uni.setStorageSync(JWTVALIDATETIME, getNowDate())
			uni.setStorageSync(JWTVALIDATE, res.data.data.jwtValidate)
			resolve(res)
		}).catch(err => {
			reject(err)
		})
	})
}
```

## ã€æ‹“å±•ã€‘ä»£ç è§„èŒƒ

**ä¸ºä»€ä¹ˆéœ€è¦ä»£ç è§„èŒƒ**

å¦‚æœæ²¡æœ‰ç»Ÿä¸€ä»£ç é£æ ¼ï¼Œå›¢é˜Ÿåä½œä¸ä¾¿äºæŸ¥çœ‹ä»£ç æäº¤æ—¶æ‰€åšçš„ä¿®æ”¹ã€‚
